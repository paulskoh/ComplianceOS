// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Core Entities
// ============================================

model Tenant {
  id                 String   @id @default(uuid())
  name               String
  businessNumber     String?  @unique
  address            String?
  industry           String?
  headcount          Int      @default(0)
  isActive           Boolean  @default(true)
  onboardingComplete Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  users              User[]
  obligations        Obligation[]
  controls           Control[]
  artifacts          Artifact[]
  riskItems          RiskItem[]
  tasks              Task[]
  workflows          WorkflowDefinition[]
  exceptions         ExceptionRequest[]
  policies           Policy[]
  trainingModules    TrainingModule[]
  integrations       Integration[]
  inspectionPacks    InspectionPack[]
  auditLogs          AuditLogEvent[]
  companyProfile     CompanyProfile?
  plan               TenantPlan?
  readinessSnapshots ReadinessSnapshot[]
  supportTickets     SupportTicket[]
  artifactEvents     ArtifactEvent[]

  @@map("tenants")
}

enum Industry {
  TECHNOLOGY
  FINANCE
  HEALTHCARE
  RETAIL
  MANUFACTURING
  EDUCATION
  OTHER
}

enum DataType {
  EMPLOYEE_DATA
  CUSTOMER_DATA
  RESIDENT_NUMBERS
  HEALTH_DATA
  FINANCIAL_DATA
  BIOMETRIC_DATA
  LOCATION_DATA
  PAYMENT_DATA
}

enum RevenueRange {
  UNDER_1B
  ONE_B_TO_10B
  TEN_B_TO_100B
  OVER_100B
}

model CompanyProfile {
  id                       String        @id @default(uuid())
  tenantId                 String        @unique
  // Existing fields
  industry                 Industry
  employeeCount            Int
  hasRemoteWork            Boolean       @default(false)
  hasOvertimeWork          Boolean       @default(false)
  hasContractors           Boolean       @default(false)
  hasVendors               Boolean       @default(false)
  dataTypes                DataType[]
  hasInternationalTransfer Boolean       @default(false)
  annualRevenue            RevenueRange?
  // New applicability fields
  headcountBand            String? // "1-9" | "10-29" | "30-99" | "100-299" | "300+"
  workStyle                String? // "office" | "remote" | "hybrid"
  usesVendorsForData       Boolean       @default(false)
  dataCustomerPii          Boolean       @default(false)
  dataEmployeePii          Boolean       @default(false)
  dataResidentId           Boolean       @default(false)
  dataHealthData           Boolean       @default(false)
  dataPaymentData          Boolean       @default(false)
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("company_profiles")
}

enum UserRole {
  SUPER_ADMIN
  ORG_ADMIN
  COMPLIANCE_MANAGER
  HR_MANAGER
  SECURITY_MANAGER
  AUDITOR
  CONTRIBUTOR
}

model User {
  id           String    @id @default(uuid())
  tenantId     String
  email        String    @unique
  passwordHash String
  firstName    String
  lastName     String
  role         UserRole  @default(CONTRIBUTOR)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  ownedObligations                Obligation[]
  ownedControls                   Control[]
  ownedRisks                      RiskItem[]
  assignedTasks                   Task[]
  createdArtifacts                Artifact[]
  policyAcks                      PolicyAcknowledgment[]
  trainingAssignments             TrainingAssignment[]
  createdPacks                    InspectionPack[]
  startedWorkflows                WorkflowInstance[]
  createdEvidenceRequirementLinks ArtifactEvidenceRequirement[]

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

// ============================================
// Obligations
// ============================================

enum ObligationDomain {
  LABOR
  PRIVACY
  FINANCE
  CONTRACTS
  SECURITY
  TRAINING
  EQUALITY
  RECORDS
  GOVERNANCE
  FINANCIAL
  SAFETY
  SYSTEM
}

enum EvidenceFrequency {
  CONTINUOUS
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
  ON_CHANGE
}

model ObligationTemplate {
  id                   String            @id @default(uuid())
  code                 String?           @unique // Template code from YAML
  title                String
  titleKo              String
  summaryKo            String?           @map("summary_ko") @db.Text // Short summary in Korean
  description          String            @db.Text
  descriptionKo        String            @db.Text
  inspectionQuestion   String?           @db.Text // 점검 시 확인 질문 (single)
  inspectorQuestionsKo String[]          @map("inspector_questions_ko") // Multiple inspector questions (array)
  evidenceDescription  String?           @db.Text // Required evidence description
  domain               ObligationDomain
  evidenceFrequency    EvidenceFrequency
  severity             RiskSeverity      @default(MEDIUM)
  severityDefault      RiskSeverity?     @map("severity_default") // Default severity from template
  legalReference       String?           @db.Text // 법적 근거
  sourceRefs           String[]          @map("source_refs") // References to LawSource codes
  retentionRule        Json?             @map("retention_rule") // Retention requirements
  applicabilityRule    Json?             @map("applicability_rule") // Applicability rule DSL
  contentVersion       Int               @default(1) @map("content_version") // Version tracking
  isActive             Boolean           @default(true)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  obligations Obligation[]

  @@map("obligation_templates")
}

model Obligation {
  id                   String            @id @default(uuid())
  tenantId             String
  templateId           String?
  fromTemplateCode     String?           @map("from_template_code") // Template code this was instantiated from
  code                 String? // Obligation code
  title                String
  titleKo              String?
  description          String            @db.Text
  domain               ObligationDomain
  evidenceFrequency    EvidenceFrequency
  severity             RiskSeverity      @default(MEDIUM) // Severity level
  status               String            @default("ACTIVE") // Status: ACTIVE, INACTIVE, etc.
  ownerId              String?
  applicabilityMatched Json?             @map("applicability_matched") // Matched applicability conditions
  isActive             Boolean           @default(true)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  tenant   Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template ObligationTemplate? @relation(fields: [templateId], references: [id])
  owner    User?               @relation(fields: [ownerId], references: [id])

  controls  ControlObligation[]
  artifacts ArtifactObligation[]
  riskItems RiskItem[]

  @@index([tenantId])
  @@index([domain])
  @@index([fromTemplateCode])
  @@index([code])
  @@index([status])
  @@map("obligations")
}

// ============================================
// Controls
// ============================================

enum ControlType {
  PREVENTIVE
  DETECTIVE
  CORRECTIVE
}

enum AutomationLevel {
  MANUAL
  SEMI_AUTOMATED
  FULLY_AUTOMATED
}

model ControlTemplate {
  id                 String           @id @default(uuid())
  code               String?          @unique // Template code from YAML
  obligationCode     String?          @map("obligation_code") // Reference to obligation template code
  name               String
  nameKo             String
  description        String           @db.Text
  descriptionKo      String           @db.Text
  purposeKo          String?          @db.Text // Purpose in Korean
  ownerRoleSuggested UserRole? // Suggested owner role
  type               ControlType      @default(PREVENTIVE)
  automationLevel    AutomationLevel  @default(MANUAL)
  domain             ObligationDomain
  contentVersion     Int              @default(1) @map("content_version") // Version tracking
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  controls Control[]

  @@index([obligationCode])
  @@map("control_templates")
}

model Control {
  id                   String          @id @default(uuid())
  tenantId             String
  templateId           String?
  fromTemplateCode     String?         @map("from_template_code") // Template code this was instantiated from
  code                 String? // Control code
  name                 String
  description          String          @db.Text
  type                 ControlType
  controlType          String?         @map("controlType") // Alias for type (for evaluation service)
  automationLevel      AutomationLevel
  implementationStatus String          @default("NOT_STARTED") @map("implementationStatus") // Implementation status
  ownerId              String?
  isActive             Boolean         @default(true)
  // Evaluation tracking
  lastEvaluatedAt      DateTime?       @map("last_evaluated_at")
  evaluationStatus     String?         @map("evaluation_status") // PASS/FAIL/WARN
  evaluationDetails    Json?           @map("evaluation_details")
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  tenant   Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template ControlTemplate? @relation(fields: [templateId], references: [id])
  owner    User?            @relation(fields: [ownerId], references: [id])

  obligations          ControlObligation[]
  evidenceRequirements ControlEvidenceRequirement[]
  artifacts            ArtifactControl[]
  riskItems            RiskItem[]
  exceptions           ExceptionRequest[]

  @@index([tenantId])
  @@index([fromTemplateCode])
  @@index([evaluationStatus])
  @@index([code])
  @@index([implementationStatus])
  @@map("controls")
}

model ControlObligation {
  controlId    String
  obligationId String
  createdAt    DateTime @default(now())

  control    Control    @relation(fields: [controlId], references: [id], onDelete: Cascade)
  obligation Obligation @relation(fields: [obligationId], references: [id], onDelete: Cascade)

  @@id([controlId, obligationId])
  @@map("control_obligations")
}

model ControlEvidenceRequirement {
  id                  String   @id @default(uuid())
  controlId           String
  fromTemplateCode    String?  @map("from_template_code") // Template code this was instantiated from
  name                String
  description         String   @db.Text
  freshnessWindowDays Int
  required            Boolean  @default(true)
  isMandatory         Boolean  @default(true) @map("isMandatory") // Alias for required
  evidenceType        String   @default("DOCUMENT") @map("evidenceType") // Type of evidence
  cadenceRule         Json?    @map("cadence_rule") // Cadence rule from template
  retentionRule       Json?    @map("retentionRule") // Retention rule
  requiredFields      String[] @map("required_fields") // Required fields from template
  acceptanceCriteria  String[] @map("acceptance_criteria") // Acceptance criteria from template
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  control       Control                       @relation(fields: [controlId], references: [id], onDelete: Cascade)
  artifactLinks ArtifactEvidenceRequirement[]

  @@index([controlId])
  @@index([fromTemplateCode])
  @@map("control_evidence_requirements")
}

// ============================================
// Artifacts (Evidence)
// ============================================

enum ArtifactType {
  LOG
  REPORT
  POLICY
  APPROVAL
  SIGNED_DOCUMENT
  EXPORT
  SCREENSHOT
  OTHER
}

enum AccessClassification {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  PII
}

enum ArtifactStatus {
  PENDING_UPLOAD
  UPLOADED
  READY
  PROCESSING
  VERIFIED
  FLAGGED
  EXPIRED
  SUPERSEDED
  DELETED
}

model Artifact {
  id                    String               @id @default(uuid())
  tenantId              String
  name                  String
  description           String?              @db.Text
  type                  ArtifactType
  source                String
  accessClassification  AccessClassification
  retentionDays         Int?
  metadata              Json?
  hash                  String?
  fileName              String?              @map("fileName") // File name
  fileSize              Int?                 @map("fileSize") // File size in bytes
  mimeType              String?              @map("mimeType") // MIME type
  sha256Hash            String?              @map("sha256Hash") // SHA-256 hash
  uploadedAt            DateTime?            @map("uploadedAt") // Upload timestamp
  s3Key                 String?              @map("s3Key") // S3 key for storage
  s3Bucket              String?              @map("s3Bucket") // S3 bucket name
  etag                  String?              @map("etag") // S3 ETag for finalization verification
  evidenceRequirementId String?              @map("evidenceRequirementId") // Linked evidence requirement
  uploadedById          String
  isDeleted             Boolean              @default(false)
  deletedAt             DateTime?
  // Two-phase upload lifecycle
  status                ArtifactStatus       @default(PENDING_UPLOAD)
  version               Int                  @default(1)
  // Immutability & approval tracking
  isApproved            Boolean              @default(false)
  approvedById          String?
  approvedAt            DateTime?
  isImmutable           Boolean              @default(false) // Once true, binary cannot be modified
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  tenant     Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploadedBy User   @relation(fields: [uploadedById], references: [id])

  binary               ArtifactBinary?
  controls             ArtifactControl[]
  obligations          ArtifactObligation[]
  evidenceRequirements ArtifactEvidenceRequirement[]
  packArtifacts        PackArtifact[]
  events               ArtifactEvent[]

  @@index([tenantId])
  @@index([source])
  @@index([isDeleted])
  @@index([hash])
  @@index([sha256Hash])
  @@index([isApproved])
  @@index([evidenceRequirementId])
  @@index([status])
  @@index([version])
  @@map("artifacts")
}

model ArtifactBinary {
  id         String   @id @default(uuid())
  artifactId String   @unique
  s3Key      String
  s3Bucket   String
  fileName   String
  fileSize   Int
  mimeType   String
  createdAt  DateTime @default(now())

  artifact Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)

  @@map("artifact_binaries")
}

model ArtifactControl {
  artifactId String
  controlId  String
  createdAt  DateTime @default(now())

  artifact Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  control  Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@id([artifactId, controlId])
  @@map("artifact_controls")
}

model ArtifactObligation {
  artifactId   String
  obligationId String
  createdAt    DateTime @default(now())

  artifact   Artifact   @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  obligation Obligation @relation(fields: [obligationId], references: [id], onDelete: Cascade)

  @@id([artifactId, obligationId])
  @@map("artifact_obligations")
}

// Explicit many-to-many link between Artifacts and Evidence Requirements
model ArtifactEvidenceRequirement {
  id                    String   @id @default(uuid())
  artifactId            String
  evidenceRequirementId String
  createdAt             DateTime @default(now())
  createdByUserId       String?

  artifact            Artifact                   @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  evidenceRequirement ControlEvidenceRequirement @relation(fields: [evidenceRequirementId], references: [id], onDelete: Cascade)
  createdBy           User?                      @relation(fields: [createdByUserId], references: [id])

  @@unique([artifactId, evidenceRequirementId])
  @@index([artifactId])
  @@index([evidenceRequirementId])
  @@map("artifact_evidence_requirements")
}

// ============================================
// Artifact Events (Chain of Custody)
// ============================================

enum ArtifactEventType {
  CREATED
  METADATA_EDITED
  LINKED_TO_CONTROL
  LINKED_TO_OBLIGATION
  LINKED_EVIDENCE_REQUIREMENT
  UNLINKED_EVIDENCE_REQUIREMENT
  APPROVED
  INCLUDED_IN_PACK
  DOWNLOADED
  TOMBSTONED
  UNLINKED
}

model ArtifactEvent {
  id         String            @id @default(uuid())
  tenantId   String
  artifactId String
  eventType  ArtifactEventType
  userId     String?
  ipAddress  String?
  userAgent  String?
  metadata   Json? // Event-specific metadata
  createdAt  DateTime          @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  artifact Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([artifactId])
  @@index([eventType])
  @@index([createdAt])
  @@map("artifact_events")
}

// ============================================
// Risk Management
// ============================================

enum RiskSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskStatus {
  OPEN
  IN_REVIEW
  MITIGATED
  ACCEPTED
}

model RiskItem {
  id           String       @id @default(uuid())
  tenantId     String
  title        String
  description  String       @db.Text
  severity     RiskSeverity
  status       RiskStatus   @default(OPEN)
  obligationId String?
  controlId    String?
  ownerId      String?
  dueDate      DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  obligation Obligation? @relation(fields: [obligationId], references: [id])
  control    Control?    @relation(fields: [controlId], references: [id])
  owner      User?       @relation(fields: [ownerId], references: [id])

  tasks Task[]

  @@index([tenantId])
  @@index([status])
  @@index([severity])
  @@map("risk_items")
}

// ============================================
// Tasks
// ============================================

enum TaskStatus {
  OPEN
  IN_PROGRESS
  BLOCKED
  VERIFIED
  CLOSED
  COMPLETED
  REJECTED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model Task {
  id          String        @id @default(uuid())
  tenantId    String
  title       String
  description String?       @db.Text
  status      TaskStatus    @default(OPEN)
  type        String? // e.g., 'APPROVAL', 'NOTIFICATION', 'ACTION', 'ESCALATION'
  priority    TaskPriority? @default(MEDIUM)
  riskItemId  String?
  assigneeId  String?
  dueDate     DateTime?
  completedAt DateTime?
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  riskItem RiskItem? @relation(fields: [riskItemId], references: [id])
  assignee User?     @relation(fields: [assigneeId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@map("tasks")
}

// ============================================
// Workflows
// ============================================

model WorkflowDefinition {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?  @db.Text
  config      Json
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  instances WorkflowInstance[]

  @@index([tenantId])
  @@map("workflow_definitions")
}

enum WorkflowInstanceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
  CANCELLED
  SLA_VIOLATED
}

model WorkflowInstance {
  id           String                 @id @default(uuid())
  tenantId     String
  workflowId   String // alias for definitionId
  definitionId String
  status       WorkflowInstanceStatus @default(PENDING)
  currentStep  Int                    @default(0)
  context      Json?
  metadata     Json?
  startedById  String?
  completedAt  DateTime?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  definition WorkflowDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  startedBy  User?              @relation(fields: [startedById], references: [id])

  steps ApprovalStep[]

  @@index([definitionId])
  @@index([tenantId])
  @@map("workflow_instances")
}

enum ApprovalStepStatus {
  PENDING
  APPROVED
  REJECTED
}

model ApprovalStep {
  id         String             @id @default(uuid())
  instanceId String
  stepNumber Int
  approverId String?
  status     ApprovalStepStatus @default(PENDING)
  comments   String?            @db.Text
  approvedAt DateTime?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  instance WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId])
  @@map("approval_steps")
}

// ============================================
// Exceptions
// ============================================

enum ExceptionStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

model ExceptionRequest {
  id                   String          @id @default(uuid())
  tenantId             String
  controlId            String
  reason               String          @db.Text
  compensatingControls String?         @db.Text
  durationDays         Int
  status               ExceptionStatus @default(PENDING)
  approvedBy           String?
  approvedAt           DateTime?
  expiresAt            DateTime?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  control Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@map("exception_requests")
}

// ============================================
// Policies
// ============================================

model Policy {
  id               String   @id @default(uuid())
  tenantId         String
  name             String
  description      String?  @db.Text
  currentVersionId String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  versions        PolicyVersion[]
  acknowledgments PolicyAcknowledgment[]

  @@index([tenantId])
  @@map("policies")
}

model PolicyVersion {
  id          String    @id @default(uuid())
  policyId    String
  version     Int
  content     String    @db.Text
  publishedAt DateTime?
  createdAt   DateTime  @default(now())

  policy Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([policyId, version])
  @@index([policyId])
  @@map("policy_versions")
}

model PolicyAcknowledgment {
  id             String   @id @default(uuid())
  policyId       String
  userId         String
  versionId      String
  acknowledgedAt DateTime @default(now())

  policy Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([policyId, userId, versionId])
  @@index([userId])
  @@map("policy_acknowledgments")
}

// ============================================
// Training
// ============================================

model TrainingModule {
  id              String   @id @default(uuid())
  tenantId        String
  name            String
  description     String?  @db.Text
  content         String?  @db.Text
  durationMinutes Int?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  assignments TrainingAssignment[]

  @@index([tenantId])
  @@map("training_modules")
}

enum TrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model TrainingAssignment {
  id             String         @id @default(uuid())
  moduleId       String
  userId         String
  status         TrainingStatus @default(NOT_STARTED)
  dueDate        DateTime?
  completedAt    DateTime?
  score          Int?
  certificateUrl String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  module TrainingModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([moduleId, userId])
  @@index([userId])
  @@map("training_assignments")
}

// ============================================
// Integrations
// ============================================

enum IntegrationType {
  MANUAL_UPLOAD
  GOOGLE_DRIVE
  GOOGLE_WORKSPACE
  SLACK
  S3_IMPORT
  GENERIC_API
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
}

model Integration {
  id         String            @id @default(uuid())
  tenantId   String
  name       String
  type       IntegrationType
  config     Json
  status     IntegrationStatus @default(INACTIVE)
  lastSyncAt DateTime?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  runs IntegrationRun[]

  @@index([tenantId])
  @@map("integrations")
}

enum IntegrationRunStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model IntegrationRun {
  id                 String               @id @default(uuid())
  integrationId      String
  status             IntegrationRunStatus @default(PENDING)
  artifactsCollected Int                  @default(0)
  errorMessage       String?              @db.Text
  startedAt          DateTime?
  completedAt        DateTime?
  createdAt          DateTime             @default(now())

  integration Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@map("integration_runs")
}

// ============================================
// Inspection Packs
// ============================================

enum InspectionPackStatus {
  GENERATING
  COMPLETED
  FAILED
}

model InspectionPack {
  id                String               @id @default(uuid())
  tenantId          String
  companyId         String?              @map("companyId") // Company ID (alias for tenantId)
  name              String
  domain            ObligationDomain
  inspectionType    String               @default("GENERAL") @map("inspectionType") // Type of inspection
  startDate         DateTime
  endDate           DateTime
  status            InspectionPackStatus @default(GENERATING)
  createdById       String
  manifestS3Key     String?
  bundleS3Key       String?
  summaryS3Key      String?
  manifestJson      Json?                @map("manifest_json") // Embedded manifest with hashes/timestamps
  manifestHash      String?              @map("manifestHash") // SHA-256 hash of manifest
  manifestSignature String?              @map("manifestSignature") @db.Text // HMAC signature of manifest
  isImmutable       Boolean              @default(false) @map("is_immutable") // Once true, cannot be modified
  presetCode        String?              @map("preset_code") // Inspection preset used
  metadata          Json? // Watermark, draft status, etc
  finalizedAt       DateTime?            @map("finalizedAt") // When pack was finalized
  finalizedById     String?              @map("finalizedById") // Who finalized the pack
  revokedAt         DateTime?            @map("revokedAt") // When pack was revoked
  revocationReason  String?              @map("revocationReason") @db.Text // Why pack was revoked
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User   @relation(fields: [createdById], references: [id])

  artifacts       PackArtifact[]
  shareLinks      PackShareLink[]
  inspectorAccess InspectorAccess[]

  @@index([tenantId])
  @@index([domain])
  @@index([presetCode])
  @@map("inspection_packs")
}

model PackArtifact {
  packId     String
  artifactId String
  createdAt  DateTime @default(now())

  pack     InspectionPack @relation(fields: [packId], references: [id], onDelete: Cascade)
  artifact Artifact       @relation(fields: [artifactId], references: [id], onDelete: Cascade)

  @@id([packId, artifactId])
  @@map("pack_artifacts")
}

model PackShareLink {
  id          String   @id @default(uuid())
  packId      String
  token       String   @unique
  expiresAt   DateTime
  accessCount Int      @default(0)
  createdAt   DateTime @default(now())

  pack InspectionPack @relation(fields: [packId], references: [id], onDelete: Cascade)

  @@index([packId])
  @@index([token])
  @@map("pack_share_links")
}

// ============================================
// Tenant Plans & Limits
// ============================================

enum PlanTier {
  STARTER
  GROWTH
  ADVANCED
  ENTERPRISE
}

model TenantPlan {
  id       String   @id @default(uuid())
  tenantId String   @unique
  tier     PlanTier @default(STARTER)

  // Limits
  maxObligations   Int @default(10)
  maxIntegrations  Int @default(1)
  maxPacksPerMonth Int @default(3)
  maxStorageGB     Int @default(5)
  maxRetentionDays Int @default(365)
  maxUsers         Int @default(5)

  // Usage tracking
  obligationsUsed         Int   @default(0)
  integrationsUsed        Int   @default(0)
  packsGeneratedThisMonth Int   @default(0)
  storageUsedGB           Float @default(0)

  // Billing
  billingPeriodStart DateTime  @default(now())
  billingPeriodEnd   DateTime?
  isActive           Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("tenant_plans")
}

// ============================================
// Readiness Snapshots (Historical Tracking)
// ============================================

model ReadinessSnapshot {
  id           String   @id @default(uuid())
  tenantId     String
  snapshotDate DateTime @default(now())

  // Overall scores
  overallScore   Float
  readinessLevel String // EXCELLENT, GOOD, FAIR, POOR, CRITICAL

  // Gap counts
  totalGaps    Int
  criticalGaps Int
  highGaps     Int
  mediumGaps   Int
  lowGaps      Int

  // Domain scores (JSON array)
  domainScores Json // [{domain, score, obligations, gaps}, ...]

  // Stats
  totalObligations Int
  totalControls    Int
  totalArtifacts   Int
  totalRisks       Int
  openRisks        Int

  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([snapshotDate])
  @@map("readiness_snapshots")
}

// ============================================
// Support Tickets
// ============================================

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model SupportTicket {
  id          String         @id @default(uuid())
  tenantId    String
  userId      String?
  subject     String
  description String         @db.Text
  status      TicketStatus   @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  category    String?
  resolvedAt  DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([priority])
  @@map("support_tickets")
}

// ============================================
// Audit Log
// ============================================

enum AuditEventType {
  USER_LOGIN
  USER_LOGOUT
  USER_CREATED
  USER_UPDATED
  USER_ROLE_CHANGED
  POLICY_PUBLISHED
  POLICY_ACKNOWLEDGED
  ARTIFACT_UPLOADED
  ARTIFACT_UPLOAD_INTENT_CREATED
  ARTIFACT_FINALIZED
  ARTIFACT_DELETED
  ARTIFACT_LINKED
  ARTIFACT_APPROVED
  PACK_GENERATED
  PACK_DOWNLOADED
  DRAFT_PACK_GENERATED
  EXCEPTION_REQUESTED
  EXCEPTION_APPROVED
  WORKFLOW_STARTED
  WORKFLOW_APPROVED
  WORKFLOW_COMPLETED
  WORKFLOW_CANCELLED
  APPROVAL_GRANTED
  APPROVAL_REJECTED
  CONTROL_CREATED
  CONTROL_UPDATED
  RISK_CREATED
  RISK_UPDATED
  SIMULATION_RUN
  SHARE_LINK_CREATED
  SHARE_LINK_REVOKED
}

model AuditLogEvent {
  id           String         @id @default(uuid())
  tenantId     String
  userId       String?
  eventType    AuditEventType
  resourceType String?
  resourceId   String?
  metadata     Json?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime       @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([eventType])
  @@index([createdAt])
  @@map("audit_log_events")
}

// ============================================
// Compliance Content System
// ============================================

enum LawSourceType {
  STATUTE
  DECREE
  CHECKLIST
  MANUAL
}

model LawSource {
  id          String        @id @default(uuid())
  code        String        @unique
  titleKo     String        @map("title_ko")
  titleEn     String?       @map("title_en")
  issuer      String
  type        LawSourceType
  url         String?
  versionDate DateTime?     @map("version_date") @db.Date
  notes       String?       @db.Text
  isActive    Boolean       @default(true) @map("is_active")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@index([type])
  @@map("law_sources")
}

model EvidenceRequirementTemplate {
  id                 String   @id @default(uuid())
  code               String   @unique
  controlCode        String   @map("control_code")
  titleKo            String   @map("title_ko")
  cadenceRule        Json     @map("cadence_rule")
  requiredFields     String[] @map("required_fields")
  acceptanceCriteria String[] @map("acceptance_criteria")
  examplesKo         String[] @map("examples_ko")
  contentVersion     Int      @default(1) @map("content_version")
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@index([controlCode], map: "evidence_requirement_templates_control_code_idx")
  @@map("evidence_requirement_templates")
}

model InspectionPreset {
  id                      String   @id @default(uuid())
  code                    String   @unique
  titleKo                 String   @map("title_ko")
  includedObligationCodes String[] @map("included_obligation_codes")
  folderStructureJson     Json     @map("folder_structure_json")
  summaryTemplateKo       String   @map("summary_template_ko") @db.Text
  contentVersion          Int      @default(1) @map("content_version")
  isActive                Boolean  @default(true) @map("is_active")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@map("inspection_presets")
}

model ContentVersion {
  id             String   @id @default(uuid())
  version        Int      @unique
  loadedAt       DateTime @default(now()) @map("loaded_at")
  loadedBy       String?  @map("loaded_by")
  sourceFile     String?  @map("source_file")
  changesSummary Json?    @map("changes_summary")
  isCurrent      Boolean  @default(true) @map("is_current")

  @@index([isCurrent], map: "content_versions_is_current_idx")
  @@map("content_versions")
}

// ============================================
// Inspector Access (for external auditors)
// ============================================

model InspectorAccess {
  id                    String    @id @default(uuid())
  packId                String    @map("packId")
  token                 String    @unique
  inspectorEmail        String    @map("inspectorEmail")
  inspectorName         String    @map("inspectorName")
  inspectorOrganization String    @map("inspectorOrganization")
  expiresAt             DateTime  @map("expiresAt")
  isActive              Boolean   @default(true) @map("isActive")
  permissions           Json      @default("{}") // Permissions JSON
  createdAt             DateTime  @default(now()) @map("createdAt")
  revokedAt             DateTime? @map("revokedAt")
  revocationReason      String?   @map("revocationReason") @db.Text

  pack       InspectionPack         @relation(fields: [packId], references: [id], onDelete: Cascade)
  activities InspectorActivityLog[]

  @@index([packId])
  @@index([token])
  @@index([expiresAt])
  @@map("inspector_access")
}

// Simple inspector session for time-limited share links
model InspectorSession {
  id        String   @id @default(uuid())
  packId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([packId])
  @@index([token])
  @@map("inspector_sessions")
}

model InspectorActivityLog {
  id                String   @id @default(uuid())
  inspectorAccessId String   @map("inspectorAccessId")
  activityType      String   @map("activityType")
  metadata          Json?
  occurredAt        DateTime @default(now()) @map("occurredAt")

  inspectorAccess InspectorAccess @relation(fields: [inspectorAccessId], references: [id], onDelete: Cascade)

  @@index([inspectorAccessId])
  @@index([occurredAt])
  @@map("inspector_activity_log")
}

// ============================================
// Evidence Requirements (for evaluation engine)
// ============================================

model EvidenceRequirement {
  id            String   @id @default(uuid())
  companyId     String   @map("companyId")
  controlId     String   @map("controlId")
  name          String
  description   String?  @db.Text
  cadenceRule   Json?    @map("cadenceRule")
  retentionRule Json?    @map("retentionRule")
  isMandatory   Boolean  @default(true) @map("isMandatory")
  evidenceType  String   @default("DOCUMENT") @map("evidenceType")
  createdAt     DateTime @default(now()) @map("createdAt")
  updatedAt     DateTime @updatedAt @map("updatedAt")

  @@index([companyId])
  @@index([controlId])
  @@map("evidence_requirements")
}

// ============================================
// Risks (for auto-generated compliance risks)
// ============================================

model Risk {
  id          String    @id @default(uuid())
  companyId   String    @map("companyId")
  title       String
  description String?   @db.Text
  severity    String    @default("MEDIUM")
  status      String    @default("OPEN")
  source      String    @default("MANUAL") // MANUAL, AUTO_EVALUATION, etc.
  metadata    Json?
  createdAt   DateTime  @default(now()) @map("createdAt")
  updatedAt   DateTime  @updatedAt @map("updatedAt")
  resolvedAt  DateTime? @map("resolvedAt")

  @@index([companyId])
  @@index([status])
  @@index([severity])
  @@index([source])
  @@map("risks")
}

// ============================================
// Company (compatibility alias for Tenant)
// ============================================

model Company {
  id        String   @id
  name      String
  createdAt DateTime @default(now()) @map("createdAt")
  updatedAt DateTime @updatedAt @map("updatedAt")

  @@map("companies")
}
