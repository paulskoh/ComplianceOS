// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Core Entities
// ============================================

model Tenant {
  id                String   @id @default(uuid())
  name              String
  businessNumber    String?  @unique
  address           String?
  industry          String?
  headcount         Int      @default(0)
  isActive          Boolean  @default(true)
  onboardingComplete Boolean @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  users             User[]
  obligations       Obligation[]
  controls          Control[]
  artifacts         Artifact[]
  riskItems         RiskItem[]
  tasks             Task[]
  workflows         WorkflowDefinition[]
  exceptions        ExceptionRequest[]
  policies          Policy[]
  trainingModules   TrainingModule[]
  integrations      Integration[]
  inspectionPacks   InspectionPack[]
  auditLogs         AuditLogEvent[]
  companyProfile    CompanyProfile?

  @@map("tenants")
}

enum Industry {
  TECHNOLOGY
  FINANCE
  HEALTHCARE
  RETAIL
  MANUFACTURING
  EDUCATION
  OTHER
}

enum DataType {
  EMPLOYEE_DATA
  CUSTOMER_DATA
  RESIDENT_NUMBERS
  HEALTH_DATA
  FINANCIAL_DATA
  BIOMETRIC_DATA
  LOCATION_DATA
}

enum RevenueRange {
  UNDER_1B
  ONE_B_TO_10B
  TEN_B_TO_100B
  OVER_100B
}

model CompanyProfile {
  id                      String       @id @default(uuid())
  tenantId                String       @unique
  industry                Industry
  employeeCount           Int
  hasRemoteWork           Boolean      @default(false)
  hasOvertimeWork         Boolean      @default(false)
  hasContractors          Boolean      @default(false)
  hasVendors              Boolean      @default(false)
  dataTypes               DataType[]
  hasInternationalTransfer Boolean     @default(false)
  annualRevenue           RevenueRange?
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt

  tenant                  Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("company_profiles")
}

enum UserRole {
  SUPER_ADMIN
  ORG_ADMIN
  COMPLIANCE_MANAGER
  HR_MANAGER
  SECURITY_MANAGER
  AUDITOR
  CONTRIBUTOR
}

model User {
  id                String   @id @default(uuid())
  tenantId          String
  email             String   @unique
  passwordHash      String
  firstName         String
  lastName          String
  role              UserRole @default(CONTRIBUTOR)
  isActive          Boolean  @default(true)
  lastLoginAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  ownedObligations  Obligation[]
  ownedControls     Control[]
  ownedRisks        RiskItem[]
  assignedTasks     Task[]
  createdArtifacts  Artifact[]
  policyAcks        PolicyAcknowledgment[]
  trainingAssignments TrainingAssignment[]
  createdPacks      InspectionPack[]

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

// ============================================
// Obligations
// ============================================

enum ObligationDomain {
  LABOR
  PRIVACY
  FINANCE
  CONTRACTS
  SECURITY
  TRAINING
}

enum EvidenceFrequency {
  CONTINUOUS
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
  ON_CHANGE
}

model ObligationTemplate {
  id                String              @id @default(uuid())
  title             String
  titleKo           String?
  description       String              @db.Text
  domain            ObligationDomain
  evidenceFrequency EvidenceFrequency
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  obligations       Obligation[]

  @@map("obligation_templates")
}

model Obligation {
  id                String              @id @default(uuid())
  tenantId          String
  templateId        String?
  title             String
  titleKo           String?
  description       String              @db.Text
  domain            ObligationDomain
  evidenceFrequency EvidenceFrequency
  ownerId           String?
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template          ObligationTemplate? @relation(fields: [templateId], references: [id])
  owner             User?               @relation(fields: [ownerId], references: [id])

  controls          ControlObligation[]
  artifacts         ArtifactObligation[]
  riskItems         RiskItem[]

  @@index([tenantId])
  @@index([domain])
  @@map("obligations")
}

// ============================================
// Controls
// ============================================

enum ControlType {
  PREVENTIVE
  DETECTIVE
  CORRECTIVE
}

enum AutomationLevel {
  MANUAL
  SEMI_AUTOMATED
  FULLY_AUTOMATED
}

model Control {
  id                String          @id @default(uuid())
  tenantId          String
  name              String
  description       String          @db.Text
  type              ControlType
  automationLevel   AutomationLevel
  ownerId           String?
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  owner             User?           @relation(fields: [ownerId], references: [id])

  obligations       ControlObligation[]
  evidenceRequirements ControlEvidenceRequirement[]
  artifacts         ArtifactControl[]
  riskItems         RiskItem[]
  exceptions        ExceptionRequest[]

  @@index([tenantId])
  @@map("controls")
}

model ControlObligation {
  controlId         String
  obligationId      String
  createdAt         DateTime @default(now())

  control           Control    @relation(fields: [controlId], references: [id], onDelete: Cascade)
  obligation        Obligation @relation(fields: [obligationId], references: [id], onDelete: Cascade)

  @@id([controlId, obligationId])
  @@map("control_obligations")
}

model ControlEvidenceRequirement {
  id                   String   @id @default(uuid())
  controlId            String
  name                 String
  description          String   @db.Text
  freshnessWindowDays  Int
  required             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  control              Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@index([controlId])
  @@map("control_evidence_requirements")
}

// ============================================
// Artifacts (Evidence)
// ============================================

enum ArtifactType {
  LOG
  REPORT
  POLICY
  APPROVAL
  SIGNED_DOCUMENT
  EXPORT
  SCREENSHOT
  OTHER
}

enum AccessClassification {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  PII
}

model Artifact {
  id                   String                @id @default(uuid())
  tenantId             String
  name                 String
  description          String?               @db.Text
  type                 ArtifactType
  source               String
  accessClassification AccessClassification
  retentionDays        Int?
  metadata             Json?
  hash                 String?
  uploadedById         String
  isDeleted            Boolean               @default(false)
  deletedAt            DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploadedBy           User                  @relation(fields: [uploadedById], references: [id])

  binary               ArtifactBinary?
  controls             ArtifactControl[]
  obligations          ArtifactObligation[]
  packArtifacts        PackArtifact[]

  @@index([tenantId])
  @@index([source])
  @@index([isDeleted])
  @@map("artifacts")
}

model ArtifactBinary {
  id                String   @id @default(uuid())
  artifactId        String   @unique
  s3Key             String
  s3Bucket          String
  fileName          String
  fileSize          Int
  mimeType          String
  createdAt         DateTime @default(now())

  artifact          Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)

  @@map("artifact_binaries")
}

model ArtifactControl {
  artifactId        String
  controlId         String
  createdAt         DateTime @default(now())

  artifact          Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  control           Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@id([artifactId, controlId])
  @@map("artifact_controls")
}

model ArtifactObligation {
  artifactId        String
  obligationId      String
  createdAt         DateTime @default(now())

  artifact          Artifact   @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  obligation        Obligation @relation(fields: [obligationId], references: [id], onDelete: Cascade)

  @@id([artifactId, obligationId])
  @@map("artifact_obligations")
}

// ============================================
// Risk Management
// ============================================

enum RiskSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskStatus {
  OPEN
  IN_REVIEW
  MITIGATED
  ACCEPTED
}

model RiskItem {
  id                String        @id @default(uuid())
  tenantId          String
  title             String
  description       String        @db.Text
  severity          RiskSeverity
  status            RiskStatus    @default(OPEN)
  obligationId      String?
  controlId         String?
  ownerId           String?
  dueDate           DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  obligation        Obligation?   @relation(fields: [obligationId], references: [id])
  control           Control?      @relation(fields: [controlId], references: [id])
  owner             User?         @relation(fields: [ownerId], references: [id])

  tasks             Task[]

  @@index([tenantId])
  @@index([status])
  @@index([severity])
  @@map("risk_items")
}

// ============================================
// Tasks
// ============================================

enum TaskStatus {
  OPEN
  IN_PROGRESS
  BLOCKED
  VERIFIED
  CLOSED
}

model Task {
  id                String      @id @default(uuid())
  tenantId          String
  title             String
  description       String?     @db.Text
  status            TaskStatus  @default(OPEN)
  riskItemId        String?
  assigneeId        String?
  dueDate           DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  riskItem          RiskItem?   @relation(fields: [riskItemId], references: [id])
  assignee          User?       @relation(fields: [assigneeId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@map("tasks")
}

// ============================================
// Workflows
// ============================================

model WorkflowDefinition {
  id                String              @id @default(uuid())
  tenantId          String
  name              String
  description       String?             @db.Text
  config            Json
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  instances         WorkflowInstance[]

  @@index([tenantId])
  @@map("workflow_definitions")
}

enum WorkflowInstanceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
  CANCELLED
}

model WorkflowInstance {
  id                String                 @id @default(uuid())
  definitionId      String
  status            WorkflowInstanceStatus @default(PENDING)
  context           Json?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  definition        WorkflowDefinition     @relation(fields: [definitionId], references: [id], onDelete: Cascade)

  steps             ApprovalStep[]

  @@index([definitionId])
  @@map("workflow_instances")
}

enum ApprovalStepStatus {
  PENDING
  APPROVED
  REJECTED
}

model ApprovalStep {
  id                String              @id @default(uuid())
  instanceId        String
  stepNumber        Int
  approverId        String?
  status            ApprovalStepStatus  @default(PENDING)
  comments          String?             @db.Text
  approvedAt        DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  instance          WorkflowInstance    @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId])
  @@map("approval_steps")
}

// ============================================
// Exceptions
// ============================================

enum ExceptionStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

model ExceptionRequest {
  id                      String          @id @default(uuid())
  tenantId                String
  controlId               String
  reason                  String          @db.Text
  compensatingControls    String?         @db.Text
  durationDays            Int
  status                  ExceptionStatus @default(PENDING)
  approvedBy              String?
  approvedAt              DateTime?
  expiresAt               DateTime?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt

  tenant                  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  control                 Control         @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@map("exception_requests")
}

// ============================================
// Policies
// ============================================

model Policy {
  id                String            @id @default(uuid())
  tenantId          String
  name              String
  description       String?           @db.Text
  currentVersionId  String?
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  versions          PolicyVersion[]
  acknowledgments   PolicyAcknowledgment[]

  @@index([tenantId])
  @@map("policies")
}

model PolicyVersion {
  id                String   @id @default(uuid())
  policyId          String
  version           Int
  content           String   @db.Text
  publishedAt       DateTime?
  createdAt         DateTime @default(now())

  policy            Policy   @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([policyId, version])
  @@index([policyId])
  @@map("policy_versions")
}

model PolicyAcknowledgment {
  id                String   @id @default(uuid())
  policyId          String
  userId            String
  versionId         String
  acknowledgedAt    DateTime @default(now())

  policy            Policy   @relation(fields: [policyId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([policyId, userId, versionId])
  @@index([userId])
  @@map("policy_acknowledgments")
}

// ============================================
// Training
// ============================================

model TrainingModule {
  id                String              @id @default(uuid())
  tenantId          String
  name              String
  description       String?             @db.Text
  content           String?             @db.Text
  durationMinutes   Int?
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  assignments       TrainingAssignment[]

  @@index([tenantId])
  @@map("training_modules")
}

enum TrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model TrainingAssignment {
  id                String         @id @default(uuid())
  moduleId          String
  userId            String
  status            TrainingStatus @default(NOT_STARTED)
  dueDate           DateTime?
  completedAt       DateTime?
  score             Int?
  certificateUrl    String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  module            TrainingModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([moduleId, userId])
  @@index([userId])
  @@map("training_assignments")
}

// ============================================
// Integrations
// ============================================

enum IntegrationType {
  MANUAL_UPLOAD
  GOOGLE_DRIVE
  GOOGLE_WORKSPACE
  SLACK
  S3_IMPORT
  GENERIC_API
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
}

model Integration {
  id                String            @id @default(uuid())
  tenantId          String
  name              String
  type              IntegrationType
  config            Json
  status            IntegrationStatus @default(INACTIVE)
  lastSyncAt        DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  runs              IntegrationRun[]

  @@index([tenantId])
  @@map("integrations")
}

enum IntegrationRunStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model IntegrationRun {
  id                String               @id @default(uuid())
  integrationId     String
  status            IntegrationRunStatus @default(PENDING)
  artifactsCollected Int                 @default(0)
  errorMessage      String?              @db.Text
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime             @default(now())

  integration       Integration          @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@map("integration_runs")
}

// ============================================
// Inspection Packs
// ============================================

enum InspectionPackStatus {
  GENERATING
  COMPLETED
  FAILED
}

model InspectionPack {
  id                String               @id @default(uuid())
  tenantId          String
  name              String
  domain            ObligationDomain
  startDate         DateTime
  endDate           DateTime
  status            InspectionPackStatus @default(GENERATING)
  createdById       String
  manifestS3Key     String?
  bundleS3Key       String?
  summaryS3Key      String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  tenant            Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy         User                 @relation(fields: [createdById], references: [id])

  artifacts         PackArtifact[]
  shareLinks        PackShareLink[]

  @@index([tenantId])
  @@index([domain])
  @@map("inspection_packs")
}

model PackArtifact {
  packId            String
  artifactId        String
  createdAt         DateTime @default(now())

  pack              InspectionPack @relation(fields: [packId], references: [id], onDelete: Cascade)
  artifact          Artifact       @relation(fields: [artifactId], references: [id], onDelete: Cascade)

  @@id([packId, artifactId])
  @@map("pack_artifacts")
}

model PackShareLink {
  id                String          @id @default(uuid())
  packId            String
  token             String          @unique
  expiresAt         DateTime
  accessCount       Int             @default(0)
  createdAt         DateTime        @default(now())

  pack              InspectionPack  @relation(fields: [packId], references: [id], onDelete: Cascade)

  @@index([packId])
  @@index([token])
  @@map("pack_share_links")
}

// ============================================
// Audit Log
// ============================================

enum AuditEventType {
  USER_LOGIN
  USER_LOGOUT
  USER_CREATED
  USER_UPDATED
  USER_ROLE_CHANGED
  POLICY_PUBLISHED
  POLICY_ACKNOWLEDGED
  ARTIFACT_UPLOADED
  ARTIFACT_DELETED
  ARTIFACT_LINKED
  PACK_GENERATED
  PACK_DOWNLOADED
  EXCEPTION_REQUESTED
  EXCEPTION_APPROVED
  WORKFLOW_APPROVED
  CONTROL_CREATED
  CONTROL_UPDATED
  RISK_CREATED
  RISK_UPDATED
}

model AuditLogEvent {
  id                String         @id @default(uuid())
  tenantId          String
  userId            String?
  eventType         AuditEventType
  resourceType      String?
  resourceId        String?
  metadata          Json?
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime       @default(now())

  tenant            Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([eventType])
  @@index([createdAt])
  @@map("audit_log_events")
}
