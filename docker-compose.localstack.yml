version: '3.8'

services:
  localstack:
    container_name: complianceos-localstack
    image: localstack/localstack:latest
    ports:
      - "4566:4566"            # LocalStack Gateway
      - "4510-4559:4510-4559"  # External services port range
    environment:
      # Core LocalStack configuration
      - SERVICES=s3,kms,sts,secretsmanager
      - DEBUG=1
      - DATA_DIR=/tmp/localstack/data
      - DOCKER_HOST=unix:///var/run/docker.sock

      # AWS configuration
      - AWS_DEFAULT_REGION=ap-northeast-2
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test

      # S3 configuration
      - S3_SKIP_SIGNATURE_VALIDATION=1
      - S3_BUCKET_NAME=complianceos-artifacts-local

      # KMS configuration
      - KMS_PROVIDER=local-kms

      # LocalStack Pro features (if you have a license)
      # - LOCALSTACK_API_KEY=${LOCALSTACK_API_KEY}

      # Persistence
      - PERSISTENCE=1

    volumes:
      - "./localstack-data:/tmp/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./scripts/localstack-init.sh:/etc/localstack/init/ready.d/init-aws.sh"
    networks:
      - complianceos-network

  postgres:
    container_name: complianceos-postgres
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=complianceos
      - POSTGRES_PASSWORD=dev_password
      - POSTGRES_DB=complianceos_dev
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - complianceos-network

  redis:
    container_name: complianceos-redis
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - complianceos-network

volumes:
  postgres-data:
  redis-data:

networks:
  complianceos-network:
    driver: bridge
